name: Deploy Java WAR (per project folder)

on:
  push:
    branches: [ "main" ]          # Ä‘á»•i náº¿u báº¡n deploy nhÃ¡nh khÃ¡c
  workflow_dispatch:
    inputs:
      PROJECT_NAME:
        description: "TÃªn dá»± Ã¡n (VD: MSSQLJDBCTest)"
        required: true
      CONTEXT_NAME:
        description: "TÃªn context Tomcat (rá»—ng = ROOT /)"
        required: false
        default: ""
      WEBAPPS:
        description: "ÄÆ°á»ng dáº«n Tomcat webapps"
        required: false
        default: "/opt/tomcat10/webapps"
      TOMCAT_SERVICE:
        description: "TÃªn systemd service Tomcat"
        required: false
        default: "tomcat10"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: ${{ github.event.inputs.PROJECT_NAME }}
      CONTEXT_NAME: ${{ github.event.inputs.CONTEXT_NAME }}
      WEBAPPS: ${{ github.event.inputs.WEBAPPS }}
      TOMCAT_SERVICE: ${{ github.event.inputs.TOMCAT_SERVICE }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            PROJECT="${{ env.PROJECT_NAME }}"
            WEBAPPS="${{ env.WEBAPPS }}"
            CONTEXT="${{ env.CONTEXT_NAME }}"
            TOMCAT_SVC="${{ env.TOMCAT_SERVICE }}"
            REPO="git@github.com:${GITHUB_REPOSITORY}.git"

            echo "âž¡ï¸ Deploying $PROJECT from $REPO"

            # 1. Clone náº¿u chÆ°a cÃ³, pull náº¿u cÃ³
            if [ ! -d "/opt/$PROJECT/.git" ]; then
              echo "ðŸ“‚ Repo chÆ°a cÃ³, cloning..."
              sudo mkdir -p "/opt/$PROJECT"
              sudo chown -R $USER:$USER "/opt/$PROJECT"
              git clone "$REPO" "/opt/$PROJECT"
            else
              echo "ðŸ”„ Repo Ä‘Ã£ cÃ³, pulling latest..."
              cd "/opt/$PROJECT"
              git fetch --all
              git reset --hard origin/main
            fi

            cd "/opt/$PROJECT"

            # 2. Kiá»ƒm tra WAR trong dist/
            WAR_SRC="$(ls -t dist/*.war 2>/dev/null | head -1 || true)"
            if [ -z "$WAR_SRC" ]; then
              echo "âŒ KhÃ´ng tÃ¬m tháº¥y dist/*.war trong /opt/$PROJECT"
              exit 1
            fi

            # 3. Copy vÃ o Tomcat
            if [ -z "$CONTEXT" ]; then
              sudo rm -rf "$WEBAPPS/ROOT" "$WEBAPPS/ROOT.war" || true
              sudo cp "$WAR_SRC" "$WEBAPPS/ROOT.war"
              TARGET="$WEBAPPS/ROOT.war"
            else
              sudo rm -rf "$WEBAPPS/$CONTEXT" "$WEBAPPS/${CONTEXT}.war" || true
              sudo cp "$WAR_SRC" "$WEBAPPS/${CONTEXT}.war"
              TARGET="$WEBAPPS/${CONTEXT}.war"
            fi

            sudo chown tomcat:tomcat "$TARGET" 2>/dev/null || true
            sudo chown tomcat10:tomcat10 "$TARGET" 2>/dev/null || true

            sudo systemctl restart "$TOMCAT_SVC"

            echo "âœ… Deployed $(basename "$WAR_SRC") â†’ $TARGET"
