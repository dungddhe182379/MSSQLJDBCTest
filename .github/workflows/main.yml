name: Deploy WAR to Tomcat

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}   # object rỗng (đúng kiểu)

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy WAR (copy like your manual steps)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail

            PROJECT_DIR="/opt/MSSQLJDBCTest"
            WEBAPPS="/opt/tomcat10/webapps"
            TOMCAT_SVC="tomcat"                # đổi đúng tên service bạn tạo
            WAR_NAME="WebApplication1.war"     # hoặc để trống để lấy war mới nhất

            # 1) Pull code nếu có repo ở server
            if [ -d "$PROJECT_DIR/.git" ]; then
              cd "$PROJECT_DIR"
              git fetch --all
              git reset --hard origin/main
            fi

            # 2) Chọn WAR
            if [ -n "$WAR_NAME" ] && [ -f "$PROJECT_DIR/dist/$WAR_NAME" ]; then
              SRC="$PROJECT_DIR/dist/$WAR_NAME"
            else
              SRC="$(ls -t "$PROJECT_DIR"/dist/*.war 2>/dev/null | head -1 || true)"
            fi
            if [ -z "${SRC:-}" ] || [ ! -f "$SRC" ]; then
              echo "Khong thay file WAR trong $PROJECT_DIR/dist"; exit 1
            fi
            echo "Using WAR: $SRC"

            # 3) Copy vào webapps (giữ context /WebApplication1)
            sudo rm -rf "$WEBAPPS/WebApplication1" "$WEBAPPS/WebApplication1.war" || true
            sudo cp "$SRC" "$WEBAPPS/WebApplication1.war"

            # Nếu muốn chạy ở '/' thì dùng ROOT.war:
            # sudo rm -rf "$WEBAPPS/ROOT" "$WEBAPPS/ROOT.war" || true
            # sudo cp "$SRC" "$WEBAPPS/ROOT.war"

            # 4) Quyền file cho user tomcat
            sudo chown tomcat:tomcat "$WEBAPPS/WebApplication1.war" 2>/dev/null || true
            sudo chown tomcat:tomcat "$WEBAPPS/ROOT.war" 2>/dev/null || true

            # 5) Restart Tomcat (systemd)
            sudo systemctl restart "$TOMCAT_SVC"

            echo "Deployed $(basename "$SRC") OK"
