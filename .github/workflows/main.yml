name: Deploy WAR to Tomcat

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy WAR (take latest from dist)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail

            PROJECT_DIR="/opt/MSSQLJDBCTest"
            WEBAPPS="/opt/tomcat10/webapps"
            TOMCAT_SVC="tomcat"

            # Ensure unzip exists (jar có thể không có nếu chỉ cài JRE)
            if ! command -v unzip >/dev/null 2>&1; then
              echo "Installing unzip..."
              sudo apt-get update -y
              sudo apt-get install -y unzip
            fi

            # 1) Pull code nếu có repo
            if [ -d "$PROJECT_DIR/.git" ]; then
              cd "$PROJECT_DIR"
              git fetch --all
              git reset --hard origin/main
            fi

            # 2) Lấy WAR mới nhất
            SRC="$(ls -t "$PROJECT_DIR"/dist/*.war 2>/dev/null | head -1 || true)"
            if [ -z "${SRC:-}" ] || [ ! -f "$SRC" ]; then
              echo "Không thấy file WAR trong $PROJECT_DIR/dist"
              exit 1
            fi
            BASENAME="$(basename "$SRC")"
            echo "Using WAR: $SRC"

            # 3a) Tắt deploy theo tên WAR (tránh context con)
            # sudo rm -rf "$WEBAPPS/${BASENAME%.war}" "$WEBAPPS/$BASENAME" || true
            # sudo cp "$SRC" "$WEBAPPS/$BASENAME"

            # 3b) Deploy vào ROOT, giữ nguyên tên .war
            sudo rm -rf "$WEBAPPS/ROOT" "$WEBAPPS/ROOT.war" || true
            sudo mkdir -p "$WEBAPPS/ROOT"
            sudo cp "$SRC" "$WEBAPPS/ROOT/$BASENAME"

            cd "$WEBAPPS/ROOT"
            if command -v jar >/dev/null 2>&1; then
              sudo jar -xf "$BASENAME"
            else
              sudo unzip -o "$BASENAME"
            fi
            # tuỳ chọn: xoá file .war cho gọn
            # sudo rm -f "$WEBAPPS/ROOT/$BASENAME"

            # 3c) Dọn sạch context cũ nếu từng deploy theo tên
            sudo rm -rf "$WEBAPPS/WebApplication1" "$WEBAPPS/WebApplication1.war" || true
            sudo rm -f /opt/tomcat10/conf/Catalina/localhost/WebApplication1.xml || true
            sudo rm -rf /opt/tomcat10/work/Catalina/localhost/* || true
            sudo rm -rf /opt/tomcat10/temp/* || true

            # 4) Quyền
            sudo chown -R tomcat:tomcat "$WEBAPPS/ROOT" || true

            # 5) Restart Tomcat
            sudo systemctl restart "$TOMCAT_SVC"

            echo "Deployed $BASENAME vào ROOT (/) tại $WEBAPPS/ROOT"
