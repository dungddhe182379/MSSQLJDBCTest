name: Auto Deploy Java WAR (per project folder)

on:
  push:
    branches: [ "main" ]         # đổi nếu bạn deploy nhánh khác
  workflow_dispatch: {}           # vẫn cho chạy tay nếu muốn

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            # --- Auto values (không cần nhập tay) ---
            PROJECT="${{ github.event.repository.name }}"     # tên repo
            BRANCH="${{ github.ref_name }}"                   # nhánh push
            REPO_SSH="git@github.com:${{ github.repository }}.git"

            # Tomcat defaults (đổi nếu máy bạn khác)
            WEBAPPS="/opt/tomcat10/webapps"
            TOMCAT_SVC="tomcat10"
            CONTEXT=""                                        # rỗng = ROOT, ví dụ "myapp" nếu muốn /myapp

            echo "Deploying $PROJECT ($BRANCH) from $REPO_SSH"

            # 1) Clone nếu chưa có, pull nếu đã có
            if [ ! -d "/opt/$PROJECT/.git" ]; then
              echo "Cloning to /opt/$PROJECT..."
              if [ -d "/opt/$PROJECT" ] && [ "$(ls -A /opt/$PROJECT 2>/dev/null)" ]; then
                echo "❌ /opt/$PROJECT tồn tại nhưng không phải repo git. Hãy xoá/đổi tên thư mục này."
                exit 1
              fi
              sudo mkdir -p "/opt/$PROJECT"
              sudo chown -R $USER:$USER "/opt/$PROJECT"
              git clone "$REPO_SSH" "/opt/$PROJECT"
              cd "/opt/$PROJECT"
              git checkout "$BRANCH" || true
            else
              echo "Pulling latest..."
              cd "/opt/$PROJECT"
              git fetch --all
              git reset --hard "origin/$BRANCH"
            fi

            # 2) Lấy WAR trong dist/
            WAR_SRC="$(ls -t dist/*.war 2>/dev/null | head -1 || true)"
            if [ -z "$WAR_SRC" ]; then
              echo "❌ Không thấy dist/*.war trong /opt/$PROJECT. Hãy build WAR và commit vào repo (hoặc thêm bước build)."
              exit 1
            fi
            echo "Found WAR: $WAR_SRC"

            # 3) Deploy vào Tomcat
            if [ -z "$CONTEXT" ]; then
              sudo rm -rf "$WEBAPPS/ROOT" "$WEBAPPS/ROOT.war" || true
              sudo cp "$WAR_SRC" "$WEBAPPS/ROOT.war"
              TARGET="$WEBAPPS/ROOT.war"
            else
              sudo rm -rf "$WEBAPPS/$CONTEXT" "$WEBAPPS/${CONTEXT}.war" || true
              sudo cp "$WAR_SRC" "$WEBAPPS/${CONTEXT}.war"
              TARGET="$WEBAPPS/${CONTEXT}.war"
            fi

            # Quyền file (tuỳ user tomcat trên máy bạn)
            sudo chown tomcat10:tomcat10 "$TARGET" 2>/dev/null || \
            sudo chown tomcat:tomcat "$TARGET" 2>/dev/null || true

            sudo systemctl restart "$TOMCAT_SVC"
            echo "✅ Deployed $(basename "$WAR_SRC") → $TARGET"
